# Default dimensions and their abbreviations.
# The dimension symbols are generated by tab completion: \mbfL is ğ‹, etc.
# At the expense of easy typing, this gives a visual cue to distinguish
# dimensions from units, and also helps prevent common namespace collisions.
@dimension ğ‹ "ğ‹" Length
@dimension ğŒ "ğŒ" Mass
@dimension ğ“ "ğ“" Time
@dimension ğˆ "ğˆ" Current
@dimension ğš¯ "ğš¯" Temperature    # This one is \mbfTheta
@dimension ğ‰ "ğ‰" Luminosity
@dimension ğ "ğ" Amount

include("temperature.jl")

# Define derived dimensions.
@derived_dimension Area                 ğ‹^2
@derived_dimension Volume               ğ‹^3
@derived_dimension Frequency            inv(ğ“)
@derived_dimension Force                ğŒ*ğ‹/ğ“^2
@derived_dimension Pressure             ğŒ*ğ‹^-1*ğ“^-2
@derived_dimension Energy               ğŒ*ğ‹^2/ğ“^2
@derived_dimension Momentum             ğŒ*ğ‹/ğ“
@derived_dimension Power                ğ‹^2*ğŒ*ğ“^-3
@derived_dimension Charge               ğˆ*ğ“
@derived_dimension Voltage              ğˆ^-1*ğ‹^2*ğŒ*ğ“^-3
@derived_dimension Resistance           ğˆ^-2*ğ‹^2*ğŒ*ğ“^-3
@derived_dimension Capacitance          ğˆ^2*ğ‹^-2*ğŒ^-1*ğ“^4
@derived_dimension Inductance           ğˆ^-2*ğ‹^2*ğŒ*ğ“^-2
@derived_dimension MagneticFlux         ğˆ^-1*ğ‹^2*ğŒ*ğ“^-2
@derived_dimension HField               ğˆ/ğ‹
@derived_dimension BField               ğˆ^-1*ğŒ*ğ“^-2
@derived_dimension Action               ğ‹^2*ğŒ*ğ“^-1
@derived_dimension DynamicViscosity     ğŒ*ğ‹^-1*ğ“^-1
@derived_dimension KinematicViscosity   ğ‹^2*ğ“^-1
@derived_dimension Wavenumber           inv(ğ‹)

# Define base units. This is not to imply g is the base SI unit instead of kg.
# See the documentation for further details.
# #key:   Symbol  Display  Name      Dimension   Prefixes?
@refunit  m       "m"      Meter     ğ‹           true
@refunit  s       "s"      Second    ğ“           true
@refunit  A       "A"      Ampere    ğˆ            true
@refunit  K       "K"      Kelvin    ğš¯           true
@refunit  cd      "cd"     Candela   ğ‰            true
@refunit  g       "g"      Gram      ğŒ           true
@refunit  mol     "mol"    Mole      ğ           true

# Angles and solid angles
@unit sr      "sr"      Steradian   1                       true
@unit rad     "rad"     Radian      1                       true
@unit Â°       "Â°"       Degree      pi/180                  false
# For numerical accuracy, specific to the degree
import Base: sind, cosd, tand, secd, cscd, cotd
for (_x,_y) in ((:sin,:sind), (:cos,:cosd), (:tan,:tand),
        (:sec,:secd), (:csc,:cscd), (:cot,:cotd))
    @eval ($_x)(x::Quantity{T,typeof(NoDims),typeof(Â°)}) where {T} = ($_y)(ustrip(x))
    @eval ($_y)(x::Quantity{T,typeof(NoDims),typeof(Â°)}) where {T} = ($_y)(ustrip(x))
end

# SI and related units
@unit Hz     "Hz"       Hertz       1/s                     true
@unit N      "N"        Newton      1kg*m/s^2               true
@unit Pa     "Pa"       Pascal      1N/m^2                  true
@unit J      "J"        Joule       1N*m                    true
@unit W      "W"        Watt        1J/s                    true
@unit C      "C"        Coulomb     1A*s                    true
@unit V      "V"        Volt        1W/A                    true
@unit Î©      "Î©"        Ohm         1V/A                    true
@unit S      "S"        Siemens     1/Î©                     true
@unit F      "F"        Farad       1s^4*A^2/(kg*m^2)       true
@unit H      "H"        Henry       1J/(A^2)                true
@unit T      "T"        Tesla       1kg/(A*s^2)             true
@unit Wb     "Wb"       Weber       1kg*m^2/(A*s^2)         true
@unit lm     "lm"       Lumen       1cd*sr                  true
@unit lx     "lx"       Lux         1lm/m^2                 true
@unit Bq     "Bq"       Becquerel   1/s                     true
@unit Gy     "Gy"       Gray        1J/kg                   true
@unit Sv     "Sv"       Sievert     1J/kg                   true
@unit kat    "kat"      Katal       1mol/s                  true

# Temperature
@unit Â°C     "Â°C"       Celsius     1K                      true
Unitful.offsettemp(::Unitful.Unit{:Celsius}) = 27315//100

# Common units of time
@unit minute "minute"   Minute      60s                     false
@unit hr     "hr"       Hour        3600s                   false
@unit d      "dy"       Day         86400s                  false
@unit wk     "wk"       Week        604800s                 false

# Area
# The hectare is used more frequently than any other power-of-ten of an are.
@unit a      "a"        Are         100m^2                  false
const ha = Unitful.FreeUnits{(Unitful.Unit{:Are, Unitful.Dimensions{
    (Unitful.Dimension{:Length}(2//1),)}}(2,1//1),), typeof(ğ‹^2)}()

# Volume
# `l` is also an acceptable symbol for liters
@unit L      "L"        Liter       m^3//1000                true
for p in (:y, :z, :a, :f, :p, :n, :Î¼, :Âµ, :m, :c, :d,
    Symbol(""), :da, :h, :k, :M, :G, :T, :P, :E, :Z, :Y)
    eval(Unitful, :(const $(Symbol(p,:l)) = $(Symbol(p,:L))))
end

# Energy
const q = 1.6021766208e-19*C        # CODATA 2014; `e` means 2.718...
@unit eV     "eV"       eV          q*V                     true

# For convenience
@unit Hz2Ï€   "Hz2Ï€"     AngHertz    2Ï€/s                    true
@unit bar    "bar"      Bar         100000Pa                true
@unit atm    "atm"      Atmosphere  101325Pa                false
@unit Torr   "Torr"     Torr        101325Pa//760           true

# Constants (2014 CODATA values)        (uncertainties in final digits)
const c0 = 299_792_458*m/s              # exact
@unit c      "c"        SpeedOfLight 1c0                    false
const Î¼0 = 4Ï€*(1//10)^7*H/m         # exact (but gets promoted to Float64...)
const Âµ0 = Î¼0                       # magnetic constant
const É›0 = 1/(Î¼0*c^2)               # exact, electric constant; changes here may affect
const Ïµ0 = É›0                           # test of issue 79.
const Z0 = Î¼0*c                     # exact, impedance of free space
const G  = 6.674_08e-11*m^3/kg/s^2  # (31) gravitational constant
const gn = 9.80665*m/s^2            # exact, standard acceleration of gravity
const h  = 6.626_070_040e-34*J*s    # (81) Planck constant
const Ä§  = h/2Ï€                     # hbar
const Î¦0 = h/(2q)                   # Superconducting magnetic flux quantum
const me = 9.109_383_56e-31*kg      # (11) electron rest mass
const mn = 1.674_927_471e-27*kg     # (21) neutron rest mass
const mp = 1.672_621_898e-27*kg     # (21) proton rest mass
const Î¼B = q*Ä§/(2*me)               # Bohr magneton
const ÂµB = Î¼B
const Na = 6.022_140_857e23/mol     # (74) Avogadro constant
const R  = 8.314_459_8*J/(mol*K)    # (48) molar gass constant
const k  = 1.380_648_52e-23*(J/K)   # (79) Boltzmann constant
const Ïƒ  = Ï€^2*k^4/(60*Ä§^3*c^2)     # Stefan-Boltzmann constant

# Acceleration
@unit ge     "ge"       EarthGravity gn                     false


# CGS units
@unit dyn    "dyn"      Dyne        1g*cm/s^2               true
@unit P      "P"        Poise       1g/cm/s                 true
@unit St     "St"       Stokes      1cm^2/s                 true


#########
# Shared Imperial / US customary units

# Length
#key: Symbol    Display    Name                 Equivalent to           10^n prefixes?
@unit inch      "inch"     Inch                 (254//10000)*m          false
@unit ft        "ft"       Foot                 12inch                  false
@unit yd        "yd"       Yard                 3ft                     false
@unit mi        "mi"       Mile                 1760yd                  false

# Area
@unit ac        "ac"       Acre                 (316160658//78125)*m^2  false

# Temperatures
@unit Â°Ra       "Â°Ra"      Rankine              (5//9)*K                false
@unit Â°F        "Â°F"       Fahrenheit           (5//9)*K                false
Unitful.offsettemp(::Unitful.Unit{:Fahrenheit}) = 45967//100

# Masses
@unit lb        "lb"       Pound                0.45359237kg            false # is exact
@unit oz        "oz"       Ounce                lb//16                  false
@unit slug      "slug"     Slug                 1lb*ge*s^2/ft           false
@unit dr        "dr"       Dram                 oz//16                  false
@unit gr        "gr"       Grain                (32//875)*dr            false

# Force
@unit lbf       "lbf"      PoundsForce          1lb*ge                  false

# Energy
# Use ISO 31-4 for BTU definition
@unit cal       "cal"      Calorie              4.184J                  true
@unit btu       "btu"      BritishThermalUnit   1055.06J                false

# Pressure
@unit psi       "psi"      PoundsPerSquareInch  1lbf/inch^2             false

# More masses
@unit sl        "sl"       Slug         1lbf*s^2/ft             false

#########
# Logarithmic scales and units

@logscale dB    "dB"       Decibel      10      10      false
@logscale B     "B"        Bel          10      1       false
@logscale Np    "Np"       Neper        â„¯       1//2    true
@logscale cNp   "cNp"      Centineper   â„¯       50      true

@logunit  dBm   "dBm"      Decibel      1mW
@logunit  dBV   "dBV"      Decibel      1V
@logunit  dBu   "dBu"      Decibel      sqrt(0.6)V
@logunit  dBÎ¼V  "dBÎ¼V"     Decibel      1Î¼V
@logunit  dBSPL "dBSPL"    Decibel      20Î¼Pa
@logunit  dBFS  "dBFS"     Decibel      RootPowerRatio(1)
@logunit  dBÎ©   "dBÎ©"      Decibel      1Î©
@logunit  dBS   "dBS"      Decibel      1S

const dBÂµV = dBÎ¼V   # different character encoding of Î¼

# TODO: some more dimensions?
isrootpower_dim(::typeof(dimension(W)))         = false
isrootpower_dim(::typeof(dimension(V)))         = true
isrootpower_dim(::typeof(dimension(A)))         = true
isrootpower_dim(::typeof(dimension(Pa)))        = true
isrootpower_dim(::typeof(dimension(W/m^2/Hz)))  = false     # spectral flux dens.
isrootpower_dim(::typeof(dimension(W/m^2)))     = false     # intensity
isrootpower_dim(::typeof(ğ‹^3))                  = false     # reflectivity
isrootpower_dim(::typeof(dimension(Î©)))         = true
isrootpower_dim(::typeof(dimension(S)))         = true

#########

# `using Unitful.DefaultSymbols` will bring the following into the calling namespace:
# - Dimensions ğ‹,ğŒ,ğ“,ğˆ,ğš¯,ğ‰,ğ
# - Base and derived SI units, with SI prefixes
#   - Candela conflicts with `Base.cd` so it is not brought in (issue #102)
# - Degrees: Â°

# The following line has two different character encodings for Î¼
const si_prefixes = (:y, :z, :a, :f, :p, :n, :Î¼, :Âµ, :m, :c, :d,
    Symbol(""), :da, :h, :k, :M, :G, :T, :P, :E, :Z, :Y)

const si_no_prefix = (:m, :s, :A, :K, :g, :mol, :rad, :sr, :Hz, :N, :Pa, #:cd,
    :J, :W, :C, :V, :F, :Î©, :S, :Wb, :T, :H, :Â°C, :lm, :lx, :Bq, :Gy, :Sv, :kat)

baremodule DefaultSymbols
    import Unitful

    for u in (:ğ‹,:ğŒ,:ğ“,:ğˆ,:ğš¯,:ğ‰,:ğ)
        eval(DefaultSymbols, Expr(:import, :Unitful, u))
        eval(DefaultSymbols, Expr(:export, u))
    end

    for p in Unitful.si_prefixes
        for u in Unitful.si_no_prefix
            eval(DefaultSymbols, Expr(:import, :Unitful, Symbol(p,u)))
            eval(DefaultSymbols, Expr(:export, Symbol(p,u)))
        end
    end

    eval(DefaultSymbols, Expr(:import, :Unitful, :Â°))
    eval(DefaultSymbols, Expr(:export, :Â°))
end

#########

preferunits(kg) # others done in @refunit

"""
    Unitful.promote_to_derived()
Defines promotion rules to use derived SI units in promotion for common dimensions
of quantities:

- `J` (joule) for energy
- `N` (newton) for force
- `W` (watt) for power
- `Pa` (pascal) for pressure
- `C` (coulomb) for charge
- `V` (volt) for voltage
- `Î©` (ohm) for resistance
- `F` (farad) for capacitance
- `H` (henry) for inductance
- `Wb` (weber) for magnetic flux
- `T` (tesla) for B-field
- `J*s` (joule-second) for action

If you want this as default behavior (it was for versions of Unitful prior to 0.1.0),
consider invoking this function in your `.juliarc.jl` file which is loaded when
you open Julia. This function is not exported.
"""
function promote_to_derived()
    eval(quote
         Unitful.promote_unit(::S, ::T) where
         {S<:EnergyFreeUnits, T<:EnergyFreeUnits} = Unitful.J
         Unitful.promote_unit(::S, ::T) where
         {S<:ForceFreeUnits, T<:ForceFreeUnits} = Unitful.N
         Unitful.promote_unit(::S, ::T) where
         {S<:PowerFreeUnits, T<:PowerFreeUnits} = Unitful.W
         Unitful.promote_unit(::S, ::T) where
         {S<:PressureFreeUnits, T<:PressureFreeUnits} = Unitful.Pa
         Unitful.promote_unit(::S, ::T) where
         {S<:ChargeFreeUnits, T<:ChargeFreeUnits} = Unitful.C
         Unitful.promote_unit(::S, ::T) where
         {S<:VoltageFreeUnits, T<:VoltageFreeUnits} = Unitful.V
         Unitful.promote_unit(::S, ::T) where
         {S<:ResistanceFreeUnits, T<:ResistanceFreeUnits} = Unitful.Î©
         Unitful.promote_unit(::S, ::T) where
         {S<:CapacitanceFreeUnits, T<:CapacitanceFreeUnits} = Unitful.F
         Unitful.promote_unit(::S, ::T) where
         {S<:InductanceFreeUnits, T<:InductanceFreeUnits} = Unitful.H
         Unitful.promote_unit(::S, ::T) where
         {S<:MagneticFluxFreeUnits, T<:MagneticFluxFreeUnits} = Unitful.Wb
         Unitful.promote_unit(::S, ::T) where
         {S<:BFieldFreeUnits, T<:BFieldFreeUnits} = Unitful.T
         Unitful.promote_unit(::S, ::T) where
         {S<:ActionFreeUnits, T<:ActionFreeUnits} = Unitful.J * Unitful.s
        end)
    nothing
end
